<!DOCTYPE html>
<html lang="en">
  <head>
    <title>derdon's blog</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://derdon.github.io/blog/theme/css/main.css" type="text/css">

    <!-- Feeds -->
    <link href="https://derdon.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="derdon's blog Atom Feed" />
    <link href="https://derdon.github.io/blog/feeds/all.rss.xml"
          type="application/rss+xml" rel="alternate"
          title="derdon's blog RSS Feed" />

    <link href="https://derdon.github.io/blog/feeds/gsoc.rss.xml"
          type="application/rss+xml" rel="alternate"
          title="derdon's blog Categories RSS Feed" />

  </head>
  <body>
    <div id="margins">
      <header id="header">
        <a href="https://derdon.github.io/blog/index.html"><h1 class="strokeme">derdon's blog</h1></a>
      </header>
          <nav>
            <ul>
                <li><a href="https://derdon.github.io/blog/category/gsoc.html">gsoc</a></li> 
                <li><a href="https://derdon.github.io/blog/category/python.html">python</a></li> 
            </ul>
          </nav>
      <div id="main">
        
<article>
  <header>
    <h2 class="entry-title">
      <a href="debugging-beautifulsoup-pull-request.html" rel="bookmark" title="Permalink to Debugging BeautifulSoup Pull Request">
        Debugging BeautifulSoup Pull Request
      </a>
    </h2>
  </header>
  <time datetime="2014-06-04T00:00:00">
    Wed 04 June 2014
  </time>
  <p class="entry-content">
    <p>I started working on a pull request which replaces the XML library <a class="reference external" href="http://lxml.de">lxml</a>
with <a class="reference external" href="http://beautiful-soup-4.readthedocs.org/en/latest/">beautifulsoup</a> to have a pure-Python solution. The problem is that
some of the remote tests fail, thus the pull request cannot be merged yet.</p>
<p>When I run <tt class="docutils literal">py.test <span class="pre">--remote-data</span> astroquery/eso/tests</tt> on the master
branch, all tests pass fine. But when I call the same command on my branch
which uses beautifulsoup instead of lxml, I get <a class="reference external" href="http://bpaste.net/show/321066/">3 failing tests</a>, each
of them raising the exception <tt class="docutils literal">InconsistentTableError</tt>. Time to find out
more and debug! Simplified, the stacktraces look like this:</p>
<blockquote>
<ol class="arabic simple">
<li><tt class="docutils literal">test_Sgr_Astar</tt> -&gt; <tt class="docutils literal">EsoClass.query_instrument</tt> -&gt; <tt class="docutils literal">raise
InconsistentTableError</tt></li>
<li><tt class="docutils literal">test_empty_return</tt> -&gt; <tt class="docutils literal">EsoClass.query_survey</tt> -&gt;
<tt class="docutils literal">astropy.io.ascii.read</tt> -&gt; <tt class="docutils literal">astropy.io.ui._guess</tt> -&gt; <tt class="docutils literal">raise
InconsistentTableError</tt></li>
<li><tt class="docutils literal">test_SgrAstar_remotevslocal</tt> -&gt; <tt class="docutils literal">EsoClass.query_instrument</tt> -&gt;
<tt class="docutils literal">raise InconsistentTableError</tt></li>
</ol>
</blockquote>
<p>The exception <tt class="docutils literal">InconsistentTableError</tt> is a subclass of <tt class="docutils literal">ValueError</tt>
and is defined in <tt class="docutils literal">astropy.io.ascii.core</tt>. It has the following
docstring:</p>
<blockquote>
<p>Indicates that an input table is inconsistent in some way.</p>
<p>The default behavior of <tt class="docutils literal">BaseReader</tt> is to throw an instance of
this class if a data row doesn't match the header.</p>
</blockquote>
<p>So the failing tests fail because some table is created with inconsistent
rows. I presume this is because <tt class="docutils literal">astropy.io.ascii_read</tt> receives the web
search form instead of the generated CSV formatted string for some reason.
At least this was the case when I had trouble before. Let's check it. The
testing framework <a class="reference external" href="http://pytest.org">py.test</a> supports debugging failed tests easily via the
<tt class="docutils literal"><span class="pre">--pdb</span></tt> option. So I run the tests now like this: <tt class="docutils literal">py.test
<span class="pre">--remote-data</span> <span class="pre">--pdb</span> astroquery/eso/tests</tt>. This will launch the Python
debugger <a class="reference external" href="http://docs.python.org/library/pdb.html">pdb</a>.</p>
<pre class="literal-block">
&gt; /home/derdon/repos/python/3rdparty/astroquery/astroquery/eso/core.py(333)query_instrument()
-&gt; raise ex
(Pdb) ''.join(content.splitlines()[:3])
'&lt;html&gt;&lt;HEAD&gt;&lt;TITLE&gt;ESO Science Archive - MIDI Data Products&lt;/TITLE&gt;'
</pre>
<p>Yup, looks like <cite>content</cite> contains the web form instead of a CSV-formatted
string as it should (<cite>content</cite> is the value that is passed to <cite>Table.read</cite>
and thus passed on to <tt class="docutils literal">astropy.io.ascii_read</tt>). I think the failure is
in the method <tt class="docutils literal">_activate_form</tt> and therefore set a breakpoint via
<tt class="docutils literal">import pdb; pdb.set_trace()</tt> at the end of this method body directly
before returning. The code contains the statement <tt class="docutils literal">if form_elem.name in
inputs:</tt> where <tt class="docutils literal">form_elem</tt> is created via the loop <tt class="docutils literal">for form_elem in
<span class="pre">form.find_all(['input',</span> 'select', <span class="pre">'textarea']):</span></tt>. The following pdb
checks show that this if-statement can never be evaluated to <tt class="docutils literal">True</tt>:</p>
<pre class="literal-block">
(Pdb) inputs
{'wdbo': 'csv/download', 'max_rows_returned': 50, 'target': 'Sgr A*'}
(Pdb) [form_elem.name for form_elem in form.find_all(['input', 'select', 'textarea'])]
[u'input', u'input', u'select', u'input', u'input', u'input', u'input', u'select', u'select', u'input', u'input', u'input', u'select', u'input', u'input', u'input', u'input', u'input', u'select', u'input', u'select', u'input', u'input', u'input', u'select', u'input', u'select', u'input', u'input', u'select', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'select', u'input', u'select', u'input', u'input', u'select', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'select', u'input', u'select', u'input', u'input', u'input', u'select', u'input', u'select', u'input', u'select', u'input', u'select', u'input', u'select', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'input', u'select', u'input', u'input', u'select', u'select', u'input', u'input']
</pre>
<p>I <tt class="docutils literal">git checkout</tt> now back to master and use pdb there to see how it
<em>should</em> be working.</p>
<pre class="literal-block">
(Pdb) inputs
{'wdbo': 'csv/download', 'max_rows_returned': 50, 'target': 'Sgr A*'}
(Pdb) [form_input.name for form_input in form.inputs]
[None, None, 'wdbo', 'max_rows_returned', None, None, 'target', 'resolver', 'coord_sys', 'coord1', 'coord2', 'box', 'format', 'tab_wdb_input_file', 'wdb_input_file', 'tab_night', 'night', 'stime', 'starttime', 'etime', 'endtime', 'tab_prog_id', 'prog_id', 'tab_prog_type', 'prog_type', 'tab_obs_mode', 'obs_mode', 'tab_pi_coi', 'pi_coi', 'pi_coi_name', 'tab_prog_title', 'prog_title', 'tab_dp_id', 'dp_id', 'tab_ob_id', 'ob_id', 'tab_obs_targ_name', 'obs_targ_name', 'tab_dp_cat', 'dp_cat', 'tab_dp_type', 'dp_type', 'tab_interferometry', 'tab_dp_tech', 'dp_tech', 'tab_tpl_name', 'tpl_name', 'tab_tpl_nexp', 'tpl_nexp', 'tab_tpl_start', 'tpl_start', 'tab_del_ft_sensor', 'del_ft_sensor', 'tab_del_ft_status', 'del_ft_status', 'tab_det_ntel', 'det_ntel', 'tab_iss_conf_station1', 'iss_conf_station1', 'tab_iss_conf_station2', 'iss_conf_station2', 'tab_iss_conf_station3', 'iss_conf_station3', 'tab_ocs_obs_mode', 'ocs_obs_mode', 'tab_ocs_obs_specconf', 'ocs_obs_specconf', 'tab_ocs_obs_type', 'ocs_obs_type', 'tab_ins_grat1_wlen', 'ins_grat1_wlen', 'tab_fwhm_avg', 'fwhm_avg', 'tab_airmass_range', 'airmass_range', 'tab_night_flag', 'night_flag', 'tab_moon_illu', 'moon_illu', 'order', 'extra_columns', 'force_tabular_mode', 'full_screen_mode']
(Pdb) 'wdbo' in [form_input.name for form_input in form.inputs]
True
</pre>
<p>Zing! The last expression is always <tt class="docutils literal">False</tt> at my branch which is
problematic. Now I realize what the problem is! On lxml,
<tt class="docutils literal">form_input.name</tt> gives me the attribute value for the attribute
<tt class="docutils literal">name</tt> of the node <tt class="docutils literal">form_input</tt>. E.g. if the node <tt class="docutils literal">form_input</tt> has
the source <tt class="docutils literal">&lt;input name=foo&gt;</tt>, then <tt class="docutils literal">form_input.name</tt> will have the
value <tt class="docutils literal">'foo'</tt>. But using beautifulsoup, the value of <tt class="docutils literal">form_input.name</tt>
will be <tt class="docutils literal">'input'</tt> because it returns the name of the node as a string!</p>
<p>After having fixed the code according to my new knowledge, there is only
one remote failing test left, yay! Until next time, I think this is enough
for one blog post :-)</p>

  </p>
</article>
      </div>
      <footer>
        © by Simon Liedtke • 
        Powered by <a href="http://docs.notmyidea.org/alexis/pelican/">pelican</a>.
      </footer>
    </div>
  </body>
</html>